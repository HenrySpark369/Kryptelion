<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="documentTitle">Trading Bot Dashboard</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <button id="toggleModoOscuro" aria-label="Alternar modo oscuro" style="position: fixed; top: 10px; right: 10px; z-index: 1000;">游깿</button>
    <h1 id="tituloPrincipal">Trading Bot Dashboard</h1>

    <h2>Configurar el gr치fico</h2>
    <label for="selectorSymbol">S칤mbolo:</label>
    <select id="selectorSymbol">
        <option value="BTCUSDT">BTCUSDT</option>
        <option value="ETHUSDT">ETHUSDT</option>
        <option value="SOLUSDT">SOLUSDT</option>
    </select>

    <label for="selectorInterval">Intervalo:</label>
    <select id="selectorInterval"></select>

    <button id="cargarHistoricoBtn">Cargar Hist칩rico</button>
    <button id="actualizarGrafico">Actualizar Gr치fico</button>

    <div class="row mb-3 mt-3">
        <div class="col">
            <label for="colorCompra" class="form-label">Color se침al de Compra:</label>
            <input type="color" id="colorCompra" value="#00ff00">
        </div>
        <div class="col">
            <label for="colorVenta" class="form-label">Color se침al de Venta:</label>
            <input type="color" id="colorVenta" value="#ff0000">
        </div>
    </div>

    <div class="mb-3">
        <strong>Estado de conexi칩n:</strong>
        <span id="estadoConexion" class="badge bg-secondary">Desconocido</span>
    </div>

    <div id="chart-container" style="height: 500px; width: 100%; max-width: 100%; margin: auto;">
        <canvas id="liveChart" style="width: 100%; height: 100%;"></canvas>
        <div id="mensajeSinDatos" class="alert alert-warning mt-3 text-center d-none">
            No hay datos disponibles para el s칤mbolo e intervalo seleccionados.
        </div>
    </div>

    <h2>Exportar Se침ales de Cruce</h2>
    <label for="filtroTipo">Filtrar por tipo:</label>
    <select id="filtroTipo">
        <option value="">Todos</option>
        <option value="compra">Compra</option>
        <option value="venta">Venta</option>
    </select>
    <button id="descargarCSVBackend">Descargar CSV desde backend</button>

    <label><input type="checkbox" id="toggleCruces" checked> Mostrar se침ales en gr치fico</label>
    <br>
    <label><input type="checkbox" id="filtrar24h"> Solo 칰ltimas 24h</label>
    <button id="aplicarFiltro">Aplicar Filtro</button>

    <h3>Se침ales Detectadas</h3>
    <table border="1" id="tabla-cruces" style="width:100%; margin-top:10px;">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Tipo</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button onclick="descargarCrucesFiltrados()">Descargar se침ales filtradas (CSV)</button>

    <h3>칔ltimos Cruces Guardados</h3>
    <table class="table table-bordered" id="tabla-cruces-guardados">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Tipo</th>
                <th>Precio</th>
                <th>SMA</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Historial de 칍rdenes</h2>
    <label for="filtro-symbol">S칤mbolo:</label>
    <input type="text" id="filtro-symbol" placeholder="ETHUSDT" />

    <label for="filtro-tipo">Tipo:</label>
    <select id="filtro-tipo">
        <option value="">Todos</option>
        <option value="orden_inicial">Inicial</option>
        <option value="orden_inversa">Inversa</option>
    </select>
    <button onclick="filtrarOrdenes()">Filtrar</button>
    <button onclick="descargarCSV()">Descargar CSV</button>

    <div class="table-responsive">
        <table border="1" id="tabla-ordenes" style="width:100%; margin-top:20px;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Tipo</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <!-- Chart.js (global UMD build) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

    <!-- Adapter de Chart.js para Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.js"></script>

    <script type="module">
    import { cargarIntervalos, INTERVALOS_LABELS } from "/static/js/constants.js";

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarIntervalos();
      const selector = document.getElementById("selectorInterval");
      for (const [valor, props] of Object.entries(INTERVALOS_LABELS)) {
        const option = document.createElement("option");
        option.value = valor;
        option.textContent = props;
        selector.appendChild(option);
      }
    });
    </script>
    <script type="module" src="/static/js/live-chart.js"></script>
    <!-- Spinner de carga -->
    <div id="spinnerCarga" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>
</body>
</html>