<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title id="documentTitle">Trading Bot Dashboard</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #chart-container {
            height: 70vh;
            width: 100%;
            max-width: 100%;
            margin: auto;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1 id="tituloPrincipal">Trading Bot Dashboard</h1>

    <h2>Configurar el gráfico</h2>
    <label for="selectorSymbol">Símbolo:</label>
    <select id="selectorSymbol" class="">
        <option value="BTCUSDT">BTCUSDT</option>
        <option value="ETHUSDT">ETHUSDT</option>
        <option value="SOLUSDT">SOLUSDT</option>
    </select>

    <label for="selectorInterval">Intervalo:</label>
    <select id="selectorInterval" class=""></select>

    <button class="" id="cargarHistoricoBtn">Cargar Histórico</button>
    <button class="" id="actualizarGrafico">Actualizar Gráfico</button>

    <div class="row mb-3 mt-3">
        <div class="col">
            <label for="colorCompra" class="form-label">Color señal de Compra:</label>
            <input type="color" id="colorCompra" value="#00ff00" class="">
        </div>
        <div class="col">
            <label for="colorVenta" class="form-label">Color señal de Venta:</label>
            <input type="color" id="colorVenta" value="#ff0000" class="">
        </div>
    </div>

    <div class="mb-3">
        <strong>Estado de conexión:</strong>
        <span id="estadoConexion" class="badge bg-secondary">Desconocido</span>
    </div>

    <div id="chart-container" style="height: 500px; width: 100%; max-width: 100%; margin: auto;">
        <canvas id="liveChart" style="width: 100%; height: 100%;"></canvas>
        <div id="mensajeSinDatos" class="alert alert-warning mt-3 text-center d-none">
            No hay datos disponibles para el símbolo e intervalo seleccionados.
        </div>
    </div>

    <h2>Exportar Señales de Cruce</h2>
    <label for="filtroTipo">Filtrar por tipo:</label>
    <select id="filtroTipo" class="">
        <option value="">Todos</option>
        <option value="compra">Compra</option>
        <option value="venta">Venta</option>
    </select>
    <button class="" id="descargarCSVBackend">Descargar CSV desde backend</button>

    <label><input type="checkbox" id="toggleCruces" checked> Mostrar señales en gráfico</label>
    <br>
    <label><input type="checkbox" id="filtrar24h"> Solo últimas 24h</label>
    <button class="" id="aplicarFiltro">Aplicar Filtro</button>

    <h3>Señales Detectadas</h3>
    <table border="1" id="tabla-cruces" style="width:100%; margin-top:10px;">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Tipo</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="" onclick="descargarCrucesFiltrados()">Descargar señales filtradas (CSV)</button>

    <h3>Últimos Cruces Guardados</h3>
    <table class="table table-bordered" id="tabla-cruces-guardados">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Tipo</th>
                <th>Precio</th>
                <th>SMA</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Historial de Órdenes</h2>
    <label for="filtro-symbol">Símbolo:</label>
    <input type="text" id="filtro-symbol" placeholder="ETHUSDT" class="" />

    <label for="filtro-tipo">Tipo:</label>
    <select id="filtro-tipo" class="">
        <option value="">Todos</option>
        <option value="orden_inicial">Inicial</option>
        <option value="orden_inversa">Inversa</option>
    </select>
    <button class="" onclick="filtrarOrdenes()">Filtrar</button>
    <button class="" onclick="descargarCSV()">Descargar CSV</button>

    <div class="table-responsive">
        <table border="1" id="tabla-ordenes" style="width:100%; margin-top:20px;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Tipo</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>

    <!-- Chart.js (global UMD build) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

    <!-- Adapter de Chart.js para Luxon -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.js"></script>

    <script type="module">
    import { cargarIntervalos, INTERVALOS_LABELS } from "/static/js/constants.js";

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarIntervalos();
      const selector = document.getElementById("selectorInterval");
      for (const [valor, props] of Object.entries(INTERVALOS_LABELS)) {
        const option = document.createElement("option");
        option.value = valor;
        option.textContent = props;
        selector.appendChild(option);
      }
    });
    </script>
    <script type="module" src="/static/js/live-chart.js"></script>
    <!-- Spinner de carga -->
    <div id="spinnerCarga" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</body>
</html>